---
title: x86 指令集架构计算机的启动流程
tags:
  - x86 指令集架构（x86 ISA）
  - 基本输入输出系统（BIOS）
  - 主引导记录（MBR）
  - 引导加载器（Boot Loader）
categories:
  - 操作系统（OS）
abbrlink: 1164058242
date: 2023-09-07 23:03:53
---



在按下电源键后，电源开始向主板以及其它设备供电。起初由于电压还不稳定，主板芯片组会持续地向中央处理器（CPU，Central Processing Unit）的 reset 引脚输出高电平，直到电源能够稳定供电。在这一阶段中，CPU 一直处于初始化状态。该状态下的 CPU 处于{% post_link 实模式（Real-Mode）%}，其内部的 cs:ip 寄存器的值为 0xf000:0xfff0。

<!--more-->

## 基本输入输出系统（BIOS，Basic Input/Output System）

{% note info %}
如今传统 BIOS（Legacy BIOS）正逐步被淘汰，新推出的 UEFI 更加标准化，更加安全且有图形配置界面。但是出于简单性考虑，本文仍然基于 Legacy BIOS 进行讲解。
 {% endnote %}

当主板芯片组撤销 `reset` 信号后，CPU 开始从内存的 0xffff0 处继续执行。这一段内存空间存放了 BIOS 的代码。它主要负责设备自检、设置中断向量表（IVT，Interrupt Vector Table）以及填写中断例程。

![](2023-09-08-0338.png)


你可能会有疑问：BIOS 是何时被加载到内存中的呢？ 如果实际安装的 “内存” 没有 1 MiB 会怎么样？

要解释这个问题，我们需要明白内存和主存（Main Memory）的区别。内存是 CPU 可以直接访问的存储空间，主存则是实际安装的动态随机存取存储器（DRAM，Dynamic Random Access Memory）。也就是说，主存只是内存的一部分。

实际上，BIOS 的代码存在于主板的只读存储器上（ROM，Read Only Memory），ROM 是非易失性存储器，不会因为断电而丢失数据。这个 ROM 也是主存的一部分，ROM 里的数据被映射到内存的 [0xf0000, 0xfffff]。

## 主引导记录（MBR，Master Boot Record）

当 BIOS 完成所有任务后，便将控制权转交给 MBR。MBR 是一个特殊的扇区，它位于磁盘的第一个扇区，且要以 0x55，0xaa 结尾。

扇区原本是磁盘上的物理概念，是磁盘读写最小的单元，其大小通常为 512 字节。出于兼容性的考虑，闪存在逻辑上也有扇区的概念。

![](2023-09-08-0339.png)


BIOS 会按照配置的启动顺序进行启动。如果磁盘没有 MBR，那么就跳转到下一个启动项。找到 MBR 后，就会将该 MBR 加载到内存的 0x7c00 处，并转交控制权。

{% note info %}
- 0x7c00 最早出自于 IBM PC5105 的 BIOS 中。根据其开发者 Dr. David Bradley 所述，虽然该机型有 16 KiB 内存的版本，但是运行 DOS 1.0 至少需要 32 KiB 内存。又因为内存低端 1 KiB 是中断向量表，因此 MBR 被加载到了内存高端位置，多余的 512 字节作为栈使用（0x7c00 = 32 KiB - 512 B（MBR） - 512 B（栈））。
 {% endnote %}

## 引导加载器（Boot Loader）

启动的最终目的是为了加载操作系统（OS，Operating System）并转交控制权。但是 MBR 只有一个扇区的大小，这么小的空间所能做的工作及其有限，因此它会加载 Boot Loader，由它进行后续的工作。

Boot Loader 负责为 OS 提供运行环境（例如：检测内存布局、进入保护模式、设置内存分页）、加载 OS 并转交控制权。

至此，计算机由 OS 接管，启动流程结束。

## 总结

x86 指令集架构计算机的启动流程如下图所示：

![](2023-09-08-0337.png)
