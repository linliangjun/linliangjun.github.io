---
title: 计算机启动流程
tags:
  - 基本输入输出系统（BIOS）
  - 主引导记录（MBR）
  - 引导加载器（Boot Loader）
categories:
  - 操作系统（OS）
abbrlink: 1164058242
date: 2023-09-07 23:03:53
---

![](2023-09-08-0337.png)

在按下电源键后，电源开始向主板以及其它设备供电。起初由于电压还不稳定，主板芯片组会持续地向中央处理器（CPU，Central Processing Unit）发送 `reset` 信号，直到电源能够稳定供电。在这一阶段中，CPU 一直处于初始化状态。初始化状态下的 CPU 处于实模式，其内部的 cs:ip 寄存器值为 0xF000:0xFFF0。

<!--more-->

{% note info %}
- 在实模式下，地址总线的宽度是 20 位，所以一共有 1 MiB 的内存空间 。但是寄存器只有 16 位的宽度，一个寄存器无法表示所有的内存空间。因此内存寻址是分段进行的，内存地址 = 段基址 * 16 + 段内偏移地址，一般会简写为：`段基址:段内偏移地址`，例如上文的 cs:ip。

- cs 和 ip 寄存器指示了 CPU 下一条要执行的指令所在的内存地址。其中，cs 是代码段寄存器（Code Segment），提供段基址；ip 是指令指针寄存器（Instruction Pointer），提供段内偏移地址。
 {% endnote %}

当主板撤销 `reset` 信号后，CPU 开始从内存的 0xFFFF0 处往下执行。这一段内存空间存放了基本输入输出系统（BIOS，Basic Input/Output System）的代码。它主要负责设备自检、设置中断向量表（IVT，Interrupt Vector Table）以及填写中断例程。当 BIOS 完成所有任务后，便将控制权转交给主引导记录（MBR，Master Boot Record）。

{% note info %}
- BIOS 的代码实际上存在于主板的只读存储器上（ROM，Read Only Memory），ROM 是非易失性存储器，不会因为断电而丢失数据。
- 内存的 [0xF0000, 0xFFFFF] 是 BIOS ROM，共 640 KiB 大小。
- 转交控制权就是让 cs:ip 寄存器指向目标地址，使 CPU 执行目标地址的代码。
 {% endnote %}

MBR 是一个特殊的扇区，它位于存储介质的第一个扇区，且要以 0x55，0xAA 结尾。BIOS 会按照事先配置的顺序依次检查存储介质是否有 MBR。如果所有的存储介质都没有 MBR，那么启动流程到此结束；一旦检测到某个存储介质有 MBR 后，便不再进行后续的检查了。之后，BIOS 会将该 MBR 加载到内存的 0x7C00 处，并转交控制权。

{% note info %}
- 扇区原本是磁盘上的物理概念，表示最小操作的单元，其大小通常为 512 字节。出于兼容性的考虑，闪存在逻辑上也有扇区的概念。
- 0x55、0xAA 是 MBR 魔数。
- 0x7C00 最早出自于 IBM PC5105 的 BIOS 中。根据其开发者 Dr. David Bradley 所述，该机型虽然有 16 KiB 内存的版本，但是运行 DOS 1.0 至少需要 32 KiB 内存。又因为内存低端 1 KiB 是中断向量表，因此 MBR 被加载到了内存高端位置，多余的 512 字节作为栈使用（0x7C00 = 32 KiB - 512 B（MBR） - 512 B（栈））。
 {% endnote %}

启动的最终目的是为了加载操作系统（OS，Operating System）并转交控制权。但是 MBR 只有一个扇区的大小，这么小的空间所能做的工作及其有限，因此它会加载一个名为引导加载器（Boot Loader）的程序，由该程序进行后续的工作。

Boot Loader 负责为 OS 提供运行环境（例如：检测内存布局、进入保护模式、设置内存分页）、加载 OS 并转交控制权。

至此，计算机由 OS 接管，启动流程结束。
